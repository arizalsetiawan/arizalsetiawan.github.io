<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Live Scanner (ZXing)</title>
  <style>
    html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    #app{display:flex;flex-direction:column;height:100%}
    #view{flex:1;position:relative;background:#000}
    video{width:100%;height:100%;object-fit:cover}
    #bar{padding:10px;border-top:1px solid #eee;display:flex;gap:8px;align-items:center}
    #status{flex:1;font-size:14px}
    button{padding:8px 12px;border-radius:10px;border:0;background:#007aff;color:#fff;font-weight:600}
  </style>
</head>
<body>
  <div id="app">
    <div id="view"></div>
    <div id="bar">
      <div id="status">Menyiapkan kamera…</div>
      <button id="swap">Ganti Kamera</button>
    </div>
  </div>

  <!-- ZXing (ESM) -->
  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/index.min.js";

    const statusEl = document.getElementById('status');
    const swapBtn  = document.getElementById('swap');
    const view     = document.getElementById('view');

    const codeReader = new BrowserMultiFormatReader();
    let devices = [];
    let currentIndex = 0;
    let stopFn = null;

    function updateStatus(t){ statusEl.textContent = t; }

    async function listCams(){
      devices = (await codeReader.listVideoInputDevices()) || [];
      // prioritas kamera belakang
      const backIdx = devices.findIndex(d => /back|belakang|rear|environment/i.test(d.label));
      if (backIdx >= 0) currentIndex = backIdx;
    }

    async function start(idx = 0){
      try {
        updateStatus("Memulai pemindaian…");
        const deviceId = devices[idx]?.deviceId;
        // Bersihkan tampilan sebelumnya
        view.innerHTML = "";
        const videoEl = document.createElement('video');
        videoEl.setAttribute('playsinline', 'true');
        view.appendChild(videoEl);

        // Mulai decode dari kamera terpilih
        stopFn = await codeReader.decodeFromVideoDevice(
          deviceId,
          videoEl,
          (result, err, controls) => {
            if (result && result.getText) {
              const code = result.getText();
              updateStatus("Terbaca: " + code);

              // Hentikan stream agar tidak baca berulang2
              try { controls.stop(); } catch(e){}
              // Redirect ke Scriptable (ditangkap oleh shouldAllowRequest)
              const url = "scriptable://scan?code=" + encodeURIComponent(code);
              window.location.href = url;
            } else if (err) {
              // ZXing terus mencoba; biarkan
            }
          }
        );
        updateStatus("Arahkan kamera ke barcode…");
      } catch (e) {
        console.error(e);
        updateStatus("Gagal membuka kamera: " + e);
      }
    }

    swapBtn.addEventListener('click', async () => {
      if (!devices.length) return;
      currentIndex = (currentIndex + 1) % devices.length;
      try { if (stopFn) stopFn(); } catch(e){}
      await start(currentIndex);
    });

    // Boot
    (async () => {
      await listCams();
      if (!devices.length) {
        updateStatus("Tidak ada kamera tersedia / izin ditolak.");
        return;
      }
      await start(currentIndex);
    })();
  </script>
</body>
</html>
